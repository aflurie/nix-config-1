#!/bin/bash -xe

BOOT_USER=${1:-periklis}
BOOT_MACHINE=${2:-theopompos}
BOOT_BRANCH=${3:-origin/master}

VALID_USERS=("periklis" "ptsirakidis")
VALID_MACHINES=("alphaomega" "theopompos")
VALID_BRANCHES=("origin/master" "latest-release")

BASE_DIR=~/projects/"${BOOT_USER}"
BASE_MACHINE_DIR="${BASE_DIR}/dot-${BOOT_MACHINE}"

if [[ " ${VALID_USERS[*]} " != *"$BOOT_USER"* ]];
then
    echo "Provided user is not valid!"
    exit 1
fi

if [[ " ${VALID_MACHINES[*]} " != *"$BOOT_MACHINE"* ]];
then
    echo "Provided machine is not valid!"
    exit 1
fi

if [[ " ${VALID_BRANCHES[*]} " != *"$BOOT_BRANCH"* ]];
then
    echo "Provided branch is not valid!"
    exit 1
fi

echo "Booting machine $BOOT_MACHINE for $BOOT_USER on $BOOT_BRANCH"
echo
echo "Initialize base repositories"

if [ ! -d "${BASE_DIR}" ];
then
    mkdir -p "${BASE_DIR}"
fi

cd "${BASE_DIR}"
git clone --recurse-submodules git@github.com/periklis/nix-config
git clone git@github.com/periklis/nixpkgs
git clone git@github.com/periklis/dot-"${BOOT_MACHINE}"

echo
echo "Symlink $BOOT_MACHINE machine configuration"
echo ln -s "${BASE_MACHINE_DIR}/machine.nix" machine.nix

echo
echo "Initialize emacs repositories"
git clone --recurse-submodules git@github.com/periklis/dot-emacs
git clone git@github.com/periklis/dot-emacs-machines
echo ln -s ~/.emacs.d dot-emacs
echo ln -s ~/.emacs.d/common.el dot-emacs/machines/common.el
echo ln -s ~/.emacs.d/local.el dot-emacs/machines/"${BOOT_MACHINE}"/local.el

echo
echo "Initialize org repository"
git clone git@github.com/periklis/org

echo
echo "Symlink org repository"
echo ln -s ~/org org

if [[ :$PATH: != *:"/nix/var/nix/profiles/default/bin":* ]];
then
    echo
    echo "Install Nix Package Manager"
    curl https://nixos.org/nix/install | sh
fi

if [[ :$NIX_PATH: != *:"${BASE_DIR}/nix-config/nix-darwin":* ]];
then
    echo
    echo "Install Nix-Darwin Manager"
    sudo ln -s private/var/run /run
    export NIX_PATH=darwin="${BASE_DIR}"/nix-config/nix-darwin:darwin-config="${BASE_DIR}"/nix-config/configuration.nix:"${NIX_PATH}"
    "$(nix-build '<darwin>' -A system --no-out-link)"/sw/bin/darwin-rebuild build
    "$(nix-build '<darwin>' -A system --no-out-link)"/sw/bin/darwin-rebuild switch
    . /etc/static/bashrc
fi
